<!--
 * @Description: 筛选页
 * @Author: wuxxing
 * @LastEditTime: 2022-03-24 18:16:03
-->
<template>
  <div class="filterMenu-wrapper vh-bg-white">
    <!-- 标题 -->
    <!-- 筛选组 -->
    <div class="filter-main vh-p-box2">
      <div v-for="(pItem, pIndex) in filterMenu" :key="pIndex" class="filter-item">
        <RadioField
          ref="radioFieldRef"
          v-if="pItem.type === 'radio'"
          :key="pItem.field"
          v-bind="{ ...pItem, result }"
          @change="handleChangeRadio($event, pItem)"
        ></RadioField>
        <SelectField
          ref="selectFieldRef"
          v-if="pItem.type === 'select'"
          :key="pItem.field"
          v-bind="{ ...pItem, result }"
          @change="handleSelect($event, pItem)"
        ></SelectField>
        <InputField
          ref="inputFieldRef"
          v-if="pItem.type === 'input'"
          :key="pItem.field"
          v-bind="{ ...pItem, result }"
          @input="handleInput($event, pItem)"
        ></InputField>
      </div>
    </div>
    <!-- 底部按钮 -->
    <footer class="filter-footer">
      <div class="filter-button-box vh-flex-ac vh-border-t-1">
        <!-- <div
          class="filter-button-cancel vh-flex-center vh-bg-white vh-flex1 vh-border-r-1"
          @click.stop="filterCancel"
        >
          取消
        </div> -->
        <div
          class="filter-button-reset vh-flex-center vh-bg-white vh-flex1 vh-color-blue"
          @click.stop="filterReset"
        >
          重置
        </div>
        <div
          v-waves
          class="filter-button-confirm vh-flex-center vh-flex2 vh-color-white"
          @click.stop="filterConfirm"
        >
          确定
        </div>
      </div>
    </footer>
  </div>
</template>

<script>
import RadioField from './components/RadioField.vue'
import InputField from './components/InputField.vue'
import SelectField from './components/SelectField.vue'
import { isArray } from 'lodash-es'
export default {
  name: 'FilterMenu',
  components: {
    RadioField,
    InputField,
    SelectField
  },
  props: {
    filterMenu: {
      type: Array,
      default: () => [
        // 复杂数据（有层级关联的） TODO:待做
        // 普通筛选 数据结构（无关联关系的）
        {
          field: 'status',
          label: '状态',
          value: '',
          type: 'radio', // 单选
          // canAll: true, // TODO:是否开启全选功能 可以默认请求所有就无需添加该字段
          // multiple: false, // 是否开启多选 TODO:先不做
          options: [
            { label: '未审核', value: '-1' },
            { label: '已审核', value: '0' },
            { label: '未通过', value: '1' },
            { label: '审核中', value: '2' },
            { label: '已退回', value: '3' }
          ]
        },
        // pick选择
        {
          field: 'department',
          label: '科室',
          // placeholder: '请输入',
          type: 'select',
          value: '',
          options: [
            { text: '请选择', value: '' },
            { text: '科室1', value: '0' },
            { text: '科室2', value: '1' },
            { text: '科室3', value: '2' }
          ]
        },
        // 输入框
        {
          field: 'name',
          label: '制单人',
          placeholder: '请输入',
          type: 'input',
          value: ''
        },
        // 输入框
        {
          field: 'no',
          label: '单据号',
          placeholder: '请输入',
          type: 'input',
          value: ''
        }
        // 范围 选择（e.g:时间区间|价格区间等） TODO
      ],
      validator(val) {
        return isArray(val)
      }
    }
  },
  data() {
    return {
      activeArr: [0],
      list: this.filterMenu,
      result: {} // 筛选结果
    }
  },
  created() {},

  methods: {
    // filterConfirm() {},
    handleInput(val, item) {
      console.log('handleInput', val, item)
      // if (val.trim() === '') return
      this.result[item.field] = val
    },
    handleSelect(val, item) {
      console.log('handleSelect', val, item)
      this.result[item.field] = val
    },
    handleChangeRadio(val, item) {
      console.log('handleChangeRadio', val, item)
      this.result[item.field] = val
      // this.result = { ...this.result, ...val }
    },
    // 取消
    filterCancel() {
      this.$emit('cancel')
    },

    // 重置
    filterReset() {
      this.list.forEach((item, index) => {
        // if (item.type && item.type === 'tree') {
        //   // 特殊处理层级关联类型的值
        //   item.valueShow = ''
        //   item.value = ''
        // }
        if (item.type && item.type === 'input') {
          item.value = ''
          this.result[item.field] = ''
          // 获取dom
          const inputFieldRef = this.$refs.inputFieldRef
          console.log(inputFieldRef)
          inputFieldRef.forEach((ref) => {
            ref.defaultVal = ''
          })
        }

        if (item.type && item.type === 'select') {
          item.value = ''
          this.result[item.field] = ''
          // 获取dom
          const selectFieldRef = this.$refs.selectFieldRef
          console.log(selectFieldRef)
          selectFieldRef.forEach((ref) => {
            ref.defaultVal = ''
          })
        }

        if (item.type && item.type === 'radio') {
          item.value = ''
          this.result[item.field] = ''
          // 获取dom
          const radioFieldRef = this.$refs.radioFieldRef
          radioFieldRef.forEach((ref) => {
            ref.defaultVal = ''
          })

          if (item.options && item.options.length) {
            item.options.forEach((v, i) => {
              v.checked = false
              this.list[index].options.splice(i, 1, v)
              // if (v.value === 'all') {
              //   v.label = '全选'
              // }
            })
          }
        }

        // if (item.options && item.options.length) {
        //   item.options.forEach((v, i) => {
        //     v.checked = false
        //     // this.$set(v, 'checked', false)
        //     this.list[index].options.splice(i, 1, v)
        //     // if (v.value === 'all') {
        //     //   v.label = '全选'
        //     // }
        //   })
        // }
      })
    },

    // 确定
    filterConfirm() {
      const { result } = this // 筛选后的结果
      // this.list.forEach((v) => {
      //   // input 类型
      //   if ((v.type === 'input') & (v.value.trim() !== '')) {
      //     result[v.field] = v.value
      //   }
      //   if (v.options && v.options.length) {
      //     const checkedArr = v.options.reduce((count, pre) => {
      //       if (pre.value !== 'all' && pre.checked) {
      //         count.push(pre.value)
      //       }
      //       return count
      //     }, [])
      //     // console.log(checkedArr)
      //     // 处理级联数据value
      //     if (v.type === 'tree' && v.value !== '') {
      //       result[v.field] = v.value
      //     }
      //     // 过滤掉无效参数 所有选项value是否不为 ''
      //     if (checkedArr.join(',') !== '') {
      //       result[v.field] = checkedArr.join(',')
      //     }
      //   }
      // })
      for (const key in result) {
        console.log(key)
        if (key && String(result[key]).trim() === '') {
          this.$delete(result, key)
        }
      }
      const noEmptyObj = Object.keys(result).length !== 0 // 有数据
      console.log('result', result, noEmptyObj)
      this.$emit('confirm', result, noEmptyObj)
    }
  }
}
</script>

<style lang="less" scoped>
.filterMenu-wrapper {
  min-height: 100%;
  position: relative;
  .filter-main {
    // position: absolute;
    // bottom: 48px;
    // left: 0;
    .filter-item {
      //padding: 15px 12px 8px;
      /deep/ .van-cell__value {
        color: #8c8c8c;
      }
      // .filter-item-label {
      //   flex: 0 0 calc(1 * (94%) / 3);
      //   height: 34px;
      //   text-align: center;
      //   line-height: 34px;
      //   padding: 0 8px;
      //   box-sizing: border-box;
      //   margin-right: 10px;
      //   margin-bottom: 10px;
      //   border-radius: 4px;
      //   background: #f0f0f0;

      //   &:nth-child(3n) {
      //     margin-right: 0;
      //   }
      // }

      // .is-check {
      //   color: @color-blue;
      //   // border: 1PX solid @color-blue;
      //   box-sizing: border-box;
      //   background: rgba(107, 186, 255, 0.1);
      // }
    }
  }
  .filter-footer {
    height: 48px;
    .filter-button-box {
      width: 100%;
      position: fixed;
      left: 0;
      bottom: 0;

      .filter-button-reset {
        // background: @color-bg;
        height: 48px;
      }

      .filter-button-confirm {
        background: @color-blue;
        color: #fff;
        height: 48px;
      }
    }
  }
}
</style>
